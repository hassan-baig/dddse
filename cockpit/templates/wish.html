<!DOCTYPE html>

<html lang="en">

<head>
  <meta charset="utf-8" />
  <!-- Importing bootstrap via CDN -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous" />
  <title>Dev Cockpit</title>
  <link rel="icon" href="favicon.svg" type="image/gif" sizes="16x16">
  <!-- CSS -->
  <style>
    .tab {
      overflow: hidden;
      border: 1px solid #ccc;
      background-color: #f1f1f1;
    }

    .tableFixHead {
      overflow-y: auto;
      overflow-x: hidden;
      height: 200px;
      width: 90%;
    }

    .tableFixHead table {
      border-collapse: collapse;
      width: 100%;
    }

    .tableFixHead th {
      position: sticky;
      top: 0;
      background: rgb(255, 255, 255);
    }

    .greenClass {
      color: green;
    }

    .redClass {
      color: red;
    }
  </style>
</head>

<body style="overflow-x: hidden">
  <!--Javascript for Top Tab option Switch Tab between Wish and Feedback-->
  <script>
    function Show(tabName) {
      if (tabName === "Wish") {
        document.getElementById("Wish").classList.remove("d-none");
        document.getElementById("Wish").classList.add("active");
        document.getElementById("Feedback").classList.add("d-none");
        document.getElementById("Feedback").classList.remove("active");
        document.getElementById("button2").classList.remove("btn-secondary");
        document.getElementById("button2").classList.add("btn-primary");
        document.getElementById("button1").classList.remove("btn-primary");
        document.getElementById("button1").classList.add("btn-secondary");
      } else {
        document.getElementById("Feedback").classList.remove("d-none");
        document.getElementById("Feedback").classList.add("active");
        document.getElementById("Wish").classList.add("d-none");
        document.getElementById("Wish").classList.remove("active");
        document.getElementById("button1").classList.remove("btn-secondary");
        document.getElementById("button1").classList.add("btn-primary");
        document.getElementById("button2").classList.remove("btn-primary");
        document.getElementById("button2").classList.add("btn-secondary");
      }
    }
  </script>
  <!--Top Nav Bar-->
  <div>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary" style="height: 100px">
      <a class="navbar-brand" style="color: white; font-size: 200%">DDDSE Developer Cockpit</a>
      <a class="btn btn-danger offset-8" href="http://dddse.cf/logout/">Logout</a>
    </nav>
  </div>
  <br />

  <section class="container-fluid ml-3">
    <div class="tabs">
      <button type="button" id="button1" class="btn btn-md btn-primary tablinks" onclick="Show('Feedback');">
        Feedback
      </button>
      <button type="button" id="button2" class="btn btn-secondary btn-md tablinks" onclick="Show('Wish');">
        Wish
      </button>
    </div>
    <!--wish feedback-->
    <div id="Wish" class="d-none">
      <div class="row">
        <div class="col-8">
          <br />
          <h2><span class="badge badge-secondary">Wish-Pool</span></h2>
          <!--Tables-->
          <div class="tableFixHead"> 
            <table class="table table-hover" id="wishTable">
              <thead>
                <tr>
                  <th scope="col-2" onClick="sortTable('wishTable');">id</th>
                  <th scope="col-5">Text</th>
                  <th scope="col-2">category</th>
                  <th scope="col-1">#</th>
                  <th scope="col-2">Open</th>
                  <th scope="col-1">select</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div class="col-4">
          <br />
          <br />
          <br />
          <button type="button" class=" mx-auto mt-5 mb-2 btn btn-success" data-toggle="modal"
            data-target="#createVote">
            Create Vote
          </button>
          <br />
          <button type="button" class="btn btn-danger" onclick="selectedAction('deleteWish');">Delete Wish</button> 
        </div>
      </div>
      <br />
      <div class="row">
        <div class="col-8">
          <h2><span class="badge badge-secondary">Democratic-Tool</span></h2>

          <!--Tables-->
          <div class="tableFixHead">
            <table class="table table-hover" id="demoTable">
              <thead>
                <tr>
                  <th scope="col-3" onClick="sortTable('demoTable');">id</th>
                  <th scope="col-2">Due Date</th>
                  <th scope="col-2">category</th>
                  <th scope="col-2">status</th>
                  <th scope="col-2">open</th>
                  <th scope="col-1">select</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div class="col-4">
          <button type="button" class=" mx-auto mt-5 mb-2 btn btn-primary" onclick="selectedAction('createRedmineIssueVote');">
            Create Issue
          </button>
          <br />
          <button type="button" class="btn btn-danger" onclick="selectedAction('deleteVote');">Delete Vote</button>
        </div>
      </div>
    </div>

    <!-- Feedback Page-->
    <div id="Feedback" class="tabcontent active">
      <div class="row">
        <div class="col-8">
          <br />

          <h2><span class="badge badge-secondary">Feedback-Pool</span></h2>
          <!--Tables-->
          <div class="tableFixHead">
            <table class="table table-hover" id="feedbackTable">
              <thead>
                <tr>
                  <th scope="col-2" onClick="sortTable('feedbackTable');">ID</th>
                  <th scope="col-2">Datetime</th>
                  <th scope="col-2">Category</th>
                  <th scope="col-4">Text</th>
                  <th scope="col-2">Open</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
      <br />
      <div class="row">
        <div class="col-8">
          <h2>
            <span class="badge badge-secondary">Analysed FeedBack</span>
          </h2>

          <!--Tables-->
          <div class="tableFixHead">
            <table class="table table-hover" id="analyzedfeedbackTable">
              <thead>
                <tr>
                  <th scope="col-2" onClick="sortTable('analyzedfeedbackTable');">ID</th>
                  <th scope="col-4">Text</th>
                  <th scope="col-2" onClick = "sortTable1('analyzedfeedbackTable');">B/W</th>
                  <th scope="col-1">#</th>
                  <th scope="col-2">Open</th>
                  <th scope="col-1">Select</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div class="col-4">
          <button type="button" class=" mx-auto mt-5 mb-2 btn btn-primary" onclick="selectedAction('createRedmineIssue');">
            Create Issue
          </button>

          <br />
          <button type="button" class="mb-2 btn btn-secondary" onclick="selectedAction('moveToWish');">
            Move To Wish-Pool
          </button>
          <br />
          <button type="button" class="btn btn-danger" onclick="selectedAction('deleteAnalyzedFeedback');">
            Delete Feedback
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- Vote Form POPUP using Bootstrap Modal-->

  <div class="modal fade" id="createVote" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content container ">
        <div class="container">
          <form class="container mb-3 mt-3">
            <div class="form-row">
              <div class="form-group col-md-6">
                <label for="inputEmail4">Title</label>
                <input required type="text" class="form-control" id="title" placeholder="Enter Title" />
              </div>
              <div class="form-group col-md-6">
                <label for="inputPassword4">Category</label>
                <select required id="selectCategory" class="form-control">
                  <option selected>function</option>
                  <option>Design</option>
                  <option>Content</option>
                  <option>Error</option>
                  <option>Compliment</option>
                  <option>Other</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <div class="">
                <label for="inputAddress">Description</label>
                <textarea required rows="4" type="text" class="form-control" id="description" />
                </textarea>
              </div>
            </div>
            <div class="form-group">
              <label for="date">Due Date </label>
              <input required type="date" class="form-control" id="date" placeholder="yyyy-mm-dd" />
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="exampleFormControlFile1">Upload Attachments</label>
                <input required type="file" class="form-control-file" id="uploadFile" />
              </div>
            </div>
            <div class="container">
              <button style="float: right; " class="btn btn-danger mb-3" data-dismiss="modal">
                Cancel
              </button>
              <button style="float: right; " type="submit" class="btn btn-success mr-1 mb-3"
                onclick="selectedAction('postVote'); return false">
                Create Vote
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
  <!-- Open feedback form using Bootstrap Modal -->
  <div id='open'>
    <div class="modal fade" id="openFeedbackForm" tabindex="-1" role="dialog" aria-labelledby="openFeedbackFormTitle"
      aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="openFeedbackFormTitle">Feedback Details</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body" id="hy">

          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>

          </div>
        </div>
      </div>
    </div>
  </div>
  <footer></footer> <!-- Open feedback form Relevent 2nd Modal-->
  <div id='open'>
    <div class="modal fade" id="openFeedbackForm" tabindex="-1" role="dialog" aria-labelledby="openFeedbackFormTitle"
      aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="openFeedbackFormTitle">Feedback Details</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body" id="hy">

          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
  </div>


    <div id='open1'>
      <div class="modal fade" id="openFeedbackForm1" tabindex="-1" role="dialog" aria-labelledby="openFeedbackFormTitle"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="openFeedbackFormTitle">Feedback Details</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body" id="hy1">
    
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>
    </div>

  <footer></footer>

  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
    integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous">
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
    integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous">
  </script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
    integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous">
  </script>
  <script>
    let feedbacks, analyzedfeedbacks, wishes, demo,relations; //These Variables will contain data via AJAX call
    getData(); // Function Call to bring data via AJAX

    function getData() { // This Function Calls all functions that bring data and populate tables
      getFeedback();
      getAnalyzedfeedbacks();
      getDemo();
      getWishes();
    }


    function openFeedback(idd) { // On Click of Open Feedback button this function opens a popup Modal 

      if(idd!=0){ // If the IDD is not Zero This means that this function is called from another modal not from table
        var value = idd - 1; // IDD contains the feedback ID but we need Array index so we do -1 as we know array index starts from 0
        var obj = feedbacks[value]; // Obj will now contain the object from feedbacks JSON array
        var h3 = document.createElement("h4"); //These all are h4 element creations 
        var h4 = document.createElement("h4");
        var h5 = document.createElement("h4");
        var para = document.createElement("h4");
        var bw = document.createElement("h4");
        //Here we are adding HTML in created elements dynamically 
        bw.innerHTML = "<strong> Bug/Wish:</strong> " + obj.bw; // This is concatination 
        h4.innerHTML = "<strong>Date:</strong> " + obj.DateTime;
        h3.innerHTML =
          "<strong>" + "id:</strong> dddse_" +
          obj.id +
          "";
        h5.innerHTML =
          "<strong>Category:</strong> " +
          obj.category;
        para.innerHTML = "<strong>" + "Text: " + "</strong> <br />" + obj.text;
        // Here we are getting the refference to the Modal Body via ID that is hy1
        var hy1 = document.getElementById("hy1");
        hy1.innerHTML = ""; // This clears Previous HTML as it popups many times 
        // Here we are appending All above HTMLs to the Modal Body Via JS appendChild
        hy1.appendChild(h3); 
        hy1.appendChild(bw);
        hy1.appendChild(h4);
        hy1.appendChild(h5);
        hy1.appendChild(para);
        return;
      }

      //This is when IDD is ZERO It occurs when this function is called right from the Feedback Table's Open Feedback Button
      $(".modal-body").html('');

      $("#feedbackTable tr").unbind('click').click(function () {
        $(this).addClass('selected').siblings().removeClass('selected');
        var value = $(this).find('td:first').html(); // This is JQuery bringing in the ID of the Feedback that was clicked
        value = value.slice(6); // As we know we put extra dddse_ before ID So we use JS Slice method to strip that dddse_ and get the ID 
        value = value - 1; // Again this is Feedback ID we need Array index so -1
        var obj = feedbacks[value]
        var h3 = document.createElement("h4");
        var h4 = document.createElement("h4");
        var h5 = document.createElement("h4");
        var para = document.createElement("h4");
        var bw = document.createElement("h4");
        bw.innerHTML = "<strong> Bug/Wish:</strong> " + obj.bw;
        h4.innerHTML = "<strong>Date:</strong> " + obj.DateTime;
        h3.innerHTML =
          "<strong>" + "id:</strong> dddse_" +
          obj.id +
          "";
        h5.innerHTML =
          "<strong>Category:</strong> " +
          obj.category;
        para.innerHTML = "<strong>" + "Text: " + "</strong> <br />" + obj.text;
        var hy = document.getElementById("hy");
        hy.appendChild(h3);
        hy.appendChild(bw);
        hy.appendChild(h4);
        hy.appendChild(h5);
        hy.appendChild(para);
        return;
      });


      return;

    }

    function openFeedback1(idd){ // This is the function that will just call the OpenFeedback 
      document.getElementById("feedbackTable");
      openFeedback(idd);
    }

    function openAnalysedFeedback(that) { // This function is to open Analyzed Feedback's Modal on Open Feedback button click
      // Rest is more or less same as the above function
      $(".modal-body").html('');

      $("#analyzedfeedbackTable tr").unbind('click').click(function () {
        $(this).addClass('selected').siblings().removeClass('selected');
        var value = $(this).find('td:first').html();
        value = value.slice(6);
        // We are using this loop to get the Index of array because All feedbacks are not analyzed feedbacks so we do this to get where in array our ID matches
        var j = 0;
        for (i = 0; i < analyzedfeedbacks.length; i++) {
          if (value == analyzedfeedbacks[i].fid) {
            j = i;
            break;
            break;
          }
        }
        var obj = analyzedfeedbacks[j]
        var h3 = document.createElement("h4");
        var h4 = document.createElement("h4");
        var h5 = document.createElement("h4");
        var para = document.createElement("h4");
        var status = document.createElement("h4");
        var bw = document.createElement("h4");
        var relatedFeed = document.createElement("h4");
        getRelations(value); // This will Update relations array with relations of selected ID
        setTimeout(function () { // As Javascript is ASYNC So we put a 1 sec delay and after Relations array is full we do this
          relatedFeed.innerHTML = "<strong> Related Feedbacks: </strong> <br /> "
          for (i = 0; i < relations.length; i++) {
            relatedFeed.innerHTML += // This Loop prints all the related Feedbacks on Modal
              "<a onclick='openFeedback1("+relations[i]+")' data-toggle='modal' data-target='#openFeedbackForm1'>dddse_" + relations[i] + "</a> <br />"
          }
          bw.innerHTML = "<strong> Bug/Wish:</strong> " + obj.bw;
          status.innerHTML = "<strong>#:</strong> " + obj.related;
          h4.innerHTML = "<strong>Date:</strong> " + obj.DateTime;
          h3.innerHTML =
            "<strong>" + "id:</strong> dddse_" +
            obj.fid +
            "";
          h5.innerHTML =
            "<strong>Category:</strong> " +
            obj.category;
          para.innerHTML = "<strong>" + "Text: " + "</strong> <br />" + obj.text;
          var hy = document.getElementById("hy");
          hy.appendChild(h3);
          hy.appendChild(bw);
          hy.appendChild(status);
          hy.appendChild(h4);
          hy.appendChild(h5);
          hy.appendChild(para);
          hy.appendChild(relatedFeed);
        }, 1000);
        
      });
      return;

    }


    function openWish() {
    // Same as every above function it's just called from the Wish table
      $(".modal-body").html('');

      $("#wishTable tr").unbind('click').click(function () {
        $(this).addClass('selected').siblings().removeClass('selected');
        var value = $(this).find('td:first').html();
        value = value.slice(6);
        var j = 0;
        for (i = 0; i < wishes.length; i++) {
          if (value == wishes[i].fid) {
            j = i;
            break;
            break;
          }
        }
        var obj = wishes[j]
        getRelations(value);
        setTimeout(function () {
          var relatedFeed = document.createElement("h4");
          relatedFeed.innerHTML = "<strong> Related Feedbacks: </strong> <br /> "
          for (i = 0; i < relations.length; i++) {
            relatedFeed.innerHTML +=
              "<a onclick='openFeedback1(" + relations[i] + ")' data-toggle='modal' data-target='#openFeedbackForm1'>dddse_" + relations[i] + "</a> <br />"
          }
        var h3 = document.createElement("h4");
        var h4 = document.createElement("h4");
        var h5 = document.createElement("h4");
        var para = document.createElement("h4");
        var status = document.createElement("h4");
        var bw = document.createElement("h4");
        bw.innerHTML = "<strong> Bug/Wish:</strong> Wish";
        h3.innerHTML =
          "<strong>" + "id:</strong> dddse_" +
          obj.fid +
          "";
        h5.innerHTML =
          "<strong>Category:</strong> " +
          obj.category;
        para.innerHTML = "<strong>" + "Text: " + "</strong> <br />" + obj.text;

        var hy = document.getElementById("hy");
        hy.appendChild(h3);
        hy.appendChild(bw);
        hy.appendChild(h5);
        hy.appendChild(para);
        hy.appendChild(relatedFeed);
        }, 1000);
      });


      return;

    }


    function opendemo() {
      // This function is also same it just open the modal from DEMO table
      $(".modal-body").html('');

      $("#demoTable tr").unbind('click').click(function () {
        $(this).addClass('selected').siblings().removeClass('selected');
        var value = $(this).find('td:first').html();
        value = value.slice(6);
        console.log(value);
        var j = 0;
        for (i = 0; i < demo.length; i++) {
          if (value == demo[i].fid) {
            j = i;
            break;
            break;
          }
        }
        console.log(j);
        var obj = demo[j];

        var h3 = document.createElement("h4");
        var h4 = document.createElement("h4");
        var h5 = document.createElement("h4");
        var para = document.createElement("h4");
        var status = document.createElement("h4");
        var bw = document.createElement("h4");
        var votes = document.createElement("h4");
        bw.innerHTML = "<strong>Bug/Wish: </strong> " + obj.bw;
        status.innerHTML = "<strong>Title: </strong> " + obj.title;
        h4.innerHTML = "<strong>Date: </strong> " + obj.dueDate;
        h3.innerHTML =
          "<strong>FID: </strong> dddse_" +
          obj.fid;
        h5.innerHTML =
          "<strong>Category:</strong> " +
          obj.category;
        para.innerHTML = "<strong>Text: </strong><br />" + obj.description;
        votes.innerHTML = "<strong>Total votes: </strong> <br />" + obj.pvotes;
        var hy = document.getElementById("hy");
        hy.appendChild(h3);
        hy.appendChild(status);
        hy.appendChild(h4);
        hy.appendChild(h5);
        hy.appendChild(para);
        hy.appendChild(votes);
      });


      return;

    }


    function getFeedback() { // This function is responsible to fill the Feedback Table
      var xhttp = new XMLHttpRequest(); // AJAX call variable
      xhttp.onreadystatechange = function () { // Regular AJAX call
        if (this.readyState == 4 && this.status == 200) {
          DeleteRows("feedbackTable"); // Empty the table first
          feedbacks = JSON.parse(this.response); // Parse the response in to Regular JSON array
          var table = document.getElementById("feedbackTable");
          feedbacks.forEach(function (object) {  // For each object in JSON array add a row and fill the data
            var timesplit = object.DateTime.slice(0, 16);
            timesplit = timesplit.replace("T", " ");
            var newText = object.text.slice(0, 35)+".....";
            var tr = document.createElement("tr");
            tr.innerHTML =
              "<td>dddse_" +
              object.id +
              "</td>" +
              "<td>" +
              timesplit +
              "</td>" +
              "<td>" +
              object.category +
              "</td>" +
              "<td>" +
              newText +
              "</td>" +
              "<td><button  onclick='openFeedback(0)' data-toggle='modal' data-target='#openFeedbackForm'  class='btn btn-sm btn-primary'>open feedback</button></td>";
            table.appendChild(tr);
          });
        }
      };
      xhttp.open("GET", "api/feedback", true); // Regular AJAX call start
      xhttp.send();
    }

    function getAnalyzedfeedbacks() { // Same as above for analyzed Feedback
      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
          DeleteRows("analyzedfeedbackTable");
          analyzedfeedbacks = JSON.parse(this.response);
          var table = document.getElementById("analyzedfeedbackTable");
          analyzedfeedbacks.forEach(function (object) {
            var tr = document.createElement("tr");
            var newText = object.text.slice(0, 35) + ".....";
            tr.innerHTML =
              "<td>dddse_" +
              object.fid +
              "</td>" +
              "<td>" +
              newText +
              "</td>" +
              "<td>" +
              object.bw +
              "</td>" +
              "<td>" +
              object.related +
              "</td>" +
              "<td><button  onclick='openAnalysedFeedback(this)' data-toggle='modal' data-target='#openFeedbackForm'  class='btn btn-sm btn-primary'>open feedback</button></td><td><input type='checkbox' onchange='inputChanged(event)'/></td>";
            table.appendChild(tr);
          });
        }
      };
      xhttp.open("GET", "api/analyzedfeedback", true);
      xhttp.send();
    }

    function getWishes() { // Same as above
      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
          DeleteRows("wishTable");
          wishes = JSON.parse(this.response);
          var table = document.getElementById("wishTable");
          wishes.forEach(function (object) {
            var tr = document.createElement("tr");
            var newText = object.text.slice(0, 35) + ".....";
            tr.innerHTML =
              "<td >dddse_" +
              object.fid +
              "</td>" +
              "<td>" +
              newText +
              "</td>" +
              "<td>" +
              object.category +
              "</td>" +
              "<td>" +
              object.related +
              "</td>" +
              "<td><button onclick='openWish()' data-toggle='modal' data-target='#openFeedbackForm'  class='btn btn-sm btn-primary'>open feedback</button></td><td><input type='checkbox' onchange='inputChanged(event)'/></td>";
            table.appendChild(tr);
          });
        }
      };
      xhttp.open("GET", "api/wish", true);
      xhttp.send();
    }

    function getDemo() {// Same as above
      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
          DeleteRows("demoTable");
          demo = JSON.parse(this.response);
          updatevotes();
          var table = document.getElementById("demoTable");
            var k = 0;
          demo.forEach(function (object) {
            var Votestatus = // This calculates the Votes Percentage P votes means Positive Votes and Nvotes means Negative votes 
              (object.pvotes / (object.pvotes + object.nvotes)) * 100;
            if(object.pvotes == 0 && object.nvotes == 0){
              Votestatus = 0;
            }
            var tr = document.createElement("tr");
            tr.innerHTML =
              "<td>dddse_" +
              object.fid +
              "</td>" +
              "<td>" +
              object.dueDate +
              "</td>" +
              "<td>" +
              object.category +
              "</td>" +
              "<td id=" + k + ">" + // Giving a Dynamic ID So we can color it green and red
              Votestatus +
              "%</td>" +
              "<td><button  onclick='opendemo()' data-toggle='modal' data-target='#openFeedbackForm' class='btn btn-sm btn-primary'>open Vote</button></td><td><input type='checkbox' onchange='inputChanged(event)'/></td>";
            table.appendChild(tr);
            if (parseInt(Votestatus) < 50) { // If percentage is above 50 color green otherwise Red
              console.log(Votestatus);
              console.log(k);
              document.getElementById("" + k + "").classList.add("redClass");
            } else {
              console.log(Votestatus);
              console.log(k);
              document.getElementById("" + k + "").classList.add("greenClass");
            }
            k++;
          });
        }
      };
      xhttp.open("GET", "api/democratic", true);
      xhttp.send();
    }


  function getRelations(id) { // This brings the relations of a Feedback from backend and put it in Relatiosn array
    let fd = new FormData();
    fd.append("id",id);
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function () {
      if (this.readyState == 4 && this.status == 200) {
        rela = JSON.parse(this.response);
        relations = rela;
      }
    };
    xhttp.open("POST", "getrelated", true);
    xhttp.send(fd);
  }



    // It opens the POST vote modal and POST it in Backend
    function postVote(id) { // Id of the selected row from Wish table
      var token = '{{csrf_token}}'; // This is DJango default variable for secure POST AJAX request
      var title = document.getElementById("title").value; // Brings teh data from the modal Form input
      var category = document.getElementById("selectCategory").value;
      var description = document.getElementById("description").value;
      var date = document.getElementById("date").value;
      var file1 = document.querySelector('#uploadFile').files[0]; // It get first filr from the Files array
      let fd = new FormData(); // Add every thing in a formData to send
      fd.append("title", title);
      fd.append("category", category);
      fd.append("description", description);
      fd.append("dueDate", date);
      fd.append("filePath", file1);
      fd.append("fid", id);
      let request = new XMLHttpRequest();
      request.open("POST", "api/democratic/", true);
      request.setRequestHeader("X-CSRFToken", token); // For secure POST request
      request.onload = function (data) {
        console.log(this.responseText);
        deleteWish(id);
      };
      request.onerror = function () {
        console.log("error");
      };
      request.send(fd);
    }


function updatevotes(){
      demo.forEach(function (obj){ 
      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
          var vot = JSON.parse(this.response);
          var lvotes = [0,0];
          vot.forEach(function (object) {
              if(object.fid == obj.fid){
                if(object.vote == 1){
                  lvotes[0]++;
                }
                else{
                  lvotes[1]--;
                }
              }
          });
          let fd = new FormData();
          console.log(lvotes);
          fd.append("pvotes", lvotes[0]);
          fd.append("nvotes", lvotes[1]);
          var token = '{{csrf_token}}';
          var xhttp = new XMLHttpRequest();
          xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
              console.log("success");
            }
          };
          xhttp.open("PATCH", "api/democratic/" + obj.id + "", true);
          xhttp.setRequestHeader("X-CSRFToken", token);
          xhttp.send(fd);
        }
      };
      xhttp.open("GET", "api/votes/", true);
      xhttp.send();
      });
    }
 
    
    function deleteVote(id) { // This deletes any selected Vote from Demo table
      var j = 0;
      for (i = 0; i < demo.length; i++) { // Get the Index of feedback in analyzed Feedback array
        if (id == demo[i].fid) {
          j = i;
          break;
          break;
        }
      } 
      console.log(demo[j]);
      var k = demo[j].id;
      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
          console.log("success");
          setTimeout(window.location.reload(true), 500);
        }
      };
      xhttp.open("DELETE", "api/democratic/" + k + "", true);
      xhttp.send();
    } 


    function deleteAnalyzedFeedback(id) { // This deletes selected analyzed feedback from analyzed feedback table
      var j = 0;
      for (i = 0; i < analyzedfeedbacks.length; i++) { // Get the Index of feedback in analyzed Feedback array
        if (id == analyzedfeedbacks[i].fid) {
          j = i;
          break;
          break;
        }
      } 
      console.log(analyzedfeedbacks[j]);
      var k = analyzedfeedbacks[j].id
      //var token = '{{csrf_token}}';
      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
          console.log("success");
          setTimeout(window.location.reload(true), 500);
        }
      };
      xhttp.open("DELETE", "api/analyzedfeedback/" + k + "", true);
      //xhttp.setRequestHeader("X-CSRFToken", token);
      xhttp.send();
    }


    function deleteWish(id) { // Delete any selected Wish from wish table 
      var j = 0;
      for (i = 0; i < wishes.length; i++) { // Get the Index of feedback in analyzed Feedback array
        if (id == wishes[i].fid) {
          j = i;
          break;
          break;
        }
      } 
      console.log(wishes[j]);
      console.log(j);
      var k = wishes[j].id;
      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
          console.log("success");
          setTimeout(window.location.reload(true), 500);
        }
      };
      xhttp.open("DELETE", "api/wish/" + k + "", true);
      xhttp.send();
    }

    function moveToWish(id) { // This function will be called when Move to wish button is clicked
      var j = 0;
      for (i = 0; i < analyzedfeedbacks.length; i++) { // Get the Index of feedback in analyzed Feedback array
        if (id == analyzedfeedbacks[i].fid) {
          j = i;
          break;
          break;
        }
      } 
      var analyzedfeedback = analyzedfeedbacks[j];
      let fd = new FormData();
      fd.append("fid", analyzedfeedback.fid);
      fd.append("category", analyzedfeedback.category);
      fd.append("text", analyzedfeedback.text);
      fd.append("related", analyzedfeedback.related);
      let request = new XMLHttpRequest();
      request.open("POST", "api/wish/", true); // Post that selected Feedback to Wish Pool
      request.onload = function (data) {
        console.log(this.responseText);
        deleteAnalyzedFeedback(id);
      };
      request.onerror = function () {
        console.log("error");
      };
      request.send(fd);
    }


    //addNewFeedback("design","I wish there would be an option to delete a vote","wish");
    function addNewFeedback(cat, txt, bugWish) { // This is Just for testing Purpose Feel free to remove this function
      let fd = new FormData();
      fd.append("category", cat);
      fd.append("text", "Optional('"+txt+"')");
      fd.append("bw", bugWish);
      let request = new XMLHttpRequest();
      request.open("POST", "postfeedback", true);
      request.onload = function (data) {
        console.log(this.responseText);
      };
      request.onerror = function () {
        console.log("error");
      };
      request.send(fd);
    }

    // This function adds selected class to the table's rows on check box tick
    function inputChanged(event) {
      event.target.parentElement.parentElement.className =
        event.target.checked ? 'selected' : '';
    }

    // This function will be called on all button clicks and then it will call the right function
    function selectedAction(name) {
      var selectedRows = document.getElementsByClassName('selected'); // This will select all rows with selected class
      for (var i = 0; i < selectedRows.length; ++i) { // The purpose of loop is to call relevent functions on all selected rows
        var val = selectedRows[i].cells[0].innerText; // Brings first Col dddse_
        val = val.slice(6); // Removes DDDSE and only ID left
        if (name == "deleteAnalyzedFeedback") { // This checks if we should call delete analyzed feedback function
          deleteAnalyzedFeedback(val);
          setTimeout(getData, 500); // After Delete Again populate all tables so we get updated data without page refresh
        } else if (name == "deleteVote") {
          deleteVote(val);
          setTimeout(getData, 500);
        } else if (name == "deleteWish") {
          deleteWish(val);
          setTimeout(getData, 500);
        } else if (name == "moveToWish") {
          moveToWish(val);
          setTimeout(getData(), 500);
        } else if (name == "postVote") {
          if (selectedRows.length > 1) { // This will check if the user has selected More than one rows and trying to POST Vote then it shouldn't work
            alert("Please Choose One at a time");
            return
          } else {
            console.log(selectedRows.length);
            console.log("inside");
            var title = document.getElementById("title").value; // Brings teh data from the modal Form input
            var category = document.getElementById("selectCategory").value;
            var description = document.getElementById("description").value;
            var date = document.getElementById("date").value;
            var file1 = document.querySelector('#uploadFile').files[0]; 
            if (title == null || category == null || description==null || date==null || title == "" || category == "" || description==""){
              alert("Please fill all fields.");
              return
            }
            else{
            setTimeout(postVote(val), 2000); // Post Vote function call
            setTimeout(getData(), 500); 
            }
          }
        } else if (name == "createRedmineIssue") {
            postIssue(val);
        } else if (name == "createRedmineIssueVote") {
            postIssueVote(val);
        }
      }
    }

    function DeleteRows(name) { // Delete rows function is called to empty tables It is a utility function
      tbl = document.getElementById(name)
      var rowCount = tbl.rows.length;
      for (var i = rowCount - 1; i > 0; i--) {
        tbl.deleteRow(i);
      }
    }

    function postIssue(id){ // POST issue in Redmine via API
      var j = 0;
      for (i = 0; i < analyzedfeedbacks.length; i++) {
        if (id == analyzedfeedbacks[i].fid) {
          j = i;
          break;
          break;
        }
      }
      var prid = 7; // Set Higher Priority for BUG
      var analyzedfeedback = analyzedfeedbacks[j];
      fd = new FormData();
      var idd = analyzedfeedback.fid;
      fd.append('id',analyzedfeedback.fid);
      fd.append('des', analyzedfeedback.text);
      fd.append('prID', prid);
      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
          console.log(this.response);
          if(this.response == 'dddse'){
            deleteAnalyzedFeedback(idd); // Delete the feedback that's been posted in Redmine
            setTimeout(getAnalyzedfeedbacks(), 1000);
          }
        }
      };
      xhttp.open("POST", "postissue", true);
      xhttp.send(fd);
    }
    

    function postIssueVote(id) { // Called with lower priority for WISH
        var j = 0;
        for (i = 0; i < demo.length; i++) {
          if (id == demo[i].fid) {
            j = i;
            break;
            break;
          }
        }
        var prid = 6;
        var demos = demo[j];
        fd = new FormData();
        var idd = demos.fid;
        fd.append('id', demos.fid);
        fd.append('des', demos.description);
        fd.append('prID', prid);
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
          if (this.readyState == 4 && this.status == 200) {
            console.log(this.response);
            if(this.response == "dddse"){
              deleteVote(idd);
              setTimeout(getDemo(), 1000);
            }
          }
        };
        xhttp.open("POST", "postissue", true);
        xhttp.send(fd);
      }
    
  var countClick = 0;
  function sortTable(tablename) {
  var table, rows, switching, i, x, y, shouldSwitch;
  table = document.getElementById(tablename);
  switching = true;
  /*Make a loop that will continue until
  no switching has been done:*/
  while (switching) {
    //start by saying: no switching is done:
    switching = false;
    rows = table.rows;
    /*Loop through all table rows (except the
    first, which contains table headers):*/
    for (i = 1; i < (rows.length - 1); i++) {
      //start by saying there should be no switching:
      shouldSwitch = false;
      /*Get the two elements you want to compare,
      one from current row and one from the next:*/
      x = rows[i].getElementsByTagName("TD")[0];
      y = rows[i + 1].getElementsByTagName("TD")[0];
      //check if the two rows should switch place:
      var xx = x.innerHTML;
      xx = xx.slice(6);
      var yy = y.innerHTML;
      yy = yy.slice(6);
      xx = parseInt(xx);
      yy = parseInt(yy);
      if(countClick == 0){
      if (xx > yy) {
        //if so, mark as a switch and break the loop:
        shouldSwitch = true;
        countClick = 1;
        break;
      }
      }else if (countClick == 1){
       if (yy > xx) {
        //if so, mark as a switch and break the loop:
        shouldSwitch = true;
        countClick = 0;
        break;
      }
      }
    }
    if (shouldSwitch) {
      /*If a switch has been marked, make the switch
      and mark that a switch has been done:*/
      rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
      switching = true;
    }
  }
}

    
  
  </script>
</body>

</html>
